services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: caro_sql
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=Hoyo4869
    ports:
      - "1433:1433"
    volumes:
      - sql_data:/var/opt/mssql
    healthcheck:
      test: ["CMD", "/opt/mssql-tools18/bin/sqlcmd", "-S", "localhost", "-U", "sa", "-P", "Hoyo4869", "-C", "-Q", "SELECT 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  sql-init:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: caro_sql_init
    depends_on:
      sqlserver:
        condition: service_healthy
    volumes:
      - ./sql:/sql
    entrypoint: ["/opt/mssql-tools18/bin/sqlcmd", "-S", "sqlserver", "-U", "sa", "-P", "Hoyo4869", "-C", "-i", "/sql/init_schema.sql"]
    restart: "no"

  api:
    image: mcr.microsoft.com/dotnet/sdk:8.0
    container_name: caro_api
    working_dir: /app/Caro.Api
    volumes:
      - ./backend/src:/app
    command: sh -c "dotnet restore && dotnet run --urls http://0.0.0.0:8080"
    environment:
      - ASPNETCORE_URLS=http://+:8080
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Server=sqlserver,1433;Database=CaroDb;User Id=sa;Password=Hoyo4869;TrustServerCertificate=True;
      - Jwt__Issuer=Caro
      - Jwt__Audience=CaroClients
      - Jwt__Key=super_secret_dev_key_change_me_to_production_256bits_minimum_required_here
    ports:
      - "8080:8080"
    depends_on:
      sqlserver:
        condition: service_healthy
      sql-init:
        condition: service_completed_successfully

  frontend:
    image: node:20-alpine
    container_name: caro_frontend
    working_dir: /app
    volumes:
      - ./frontend:/app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    ports:
      - "5173:5173"
    environment:
      - VITE_API_BASE=http://localhost:8080
      - VITE_SIGNALR_HUB=http://localhost:8080/hub/game
    depends_on:
      - api

volumes:
  sql_data: {}


